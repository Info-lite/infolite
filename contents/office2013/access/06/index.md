---
layout: page
title: リレーションシップ（２）
date: 2015-09-18 12:30:24 +0900
purposes:
    - リレーションシップの構造をより詳しく学ぶ
    - データを変更することによって、リレーションシップが働いていることを再確認する
---

今回使うファイルです。ダウンロードしてください。

-   pencil.accdb
-   paper.accdb


### リレーションシップ
--------
<li> 主キーと外部キー

データを効率よく管理し、かつ矛盾したデータの入力を防ぐために、テーブルをいくつかに分けます。

他のテーブルの上方を参照するためにリレーションシップ（関係づけ）を作成します。

リレーションシップを作るには、共通のフィールドが必要です。

リレーションシップを形成する際に 1 件のレコードに対し、複数件のレコードを対応させる場合、 1 件のレコードが入力されている方を一側テーブルと言い、複数件のレコードが入力されている方を多側テーブルと言います。

メインとなる一側テーブルには、主キーを設定します。多側テーブルの同様の情報が入力されたフィールドを外部キーと呼び、主キーと外部キーを一致させることによってリレーションシップを形成します。

![](./pic/key.png)

<li> リレーションシップの種類

-   一対多リレーションシップ

    最も使用頻度の多いリレーションシップです。
    
    一側テーブルからの 1 件のレコードと多側テーブルからの複数件のレコードを組み合わせたリレーションシップです。上の画像が例としてあげられます。

-   一対一リレーションシップ

    一側テーブルからの 1 件のレコードと多側テーブルからの 1 件のレコードを組み合わせたリレーションシップです。

![](./pic/11table.png)

-   多対多リレーションシップ

    一側テーブルからの 1 件のレコードと多側テーブルからの複数件のレコードを組み合わせ、また、多側テーブルからの複数件のレコードと別の一側テーブルからの 1 件のレコードを組み合わせたリレーションシップです。


    一つめの一側テーブルの主キーと多側テーブルの外部キーがリレーションシップされ、さらに別の一側テーブルの主キーと多側テーブルの外部キーがリレーションシップします。

![](./pic/1t1table.png)



### リレーションシップを作成する
---
今回から"pencil.accdb"を使用します。ダウンロードして開いてください。


"pencil.accdb"からリレーションシップを作成していきます。

![](./pic/open.png)

&#9312; [データベース ツール]タブ - [リレーションシップ] - [リレーションシップ]をクリックします。

![](./pic/relationship1.png)

&#9313; [リレーションシップ ツール] - [デザイン]タブ - [リレーションシップ] - [テーブルの表示]をクリックします。

![](./pic/relationship2.png)

&#9314; "テーブルの表示"ウィンドウから以下のテーブルを選択 - [追加]をクリック - [閉じる]をクリックします。

-   顧客マスター
-   受注
-   受注明細
-   商品マスター
-   地域

![](./pic/relationship3.png)

![](./pic/relationship4.png)

&#9315; "顧客マスター"テーブルの全てのフィールドリストが見えるようにサイズを拡大します。

![](./pic/relationship5.png)

&#9316;. "受注"テーブルのフィールドリストの下に"地域"テーブルのフィールドリストを移動します。

![](./pic/relationship6.png)

&#9317; "顧客マスター"テーブルの"顧客ＩＤ"フィールドを"受注"テーブルの"顧客ＩＤ"フィールドにドラッグアンドドロップします。

![](./pic/relationship7.png)

&#9318; [作成]をクリックします。

![](./pic/relationship8.png)

&#9319; 結合線を確認してください。

![](./pic/relationship9.png)

&#9320; 同様に以下のリレーションシップを作成します。

-   "受注"テーブルと"受注明細"テーブル："受注ＩＤ"フィールド
-   "受注明細"テーブルと"商品マスター"テーブル："商品コード"フィールド
-   "地域"テーブルと"顧客マスター"テーブル："地域コード"フィールド

![](./pic/relationship10.png)

&#9321; 上書き保存をして、リレーションシップのウィンドウを閉じます。


### クエリでテーブルを結合する
---
"顧客マスター"、"受注"、"受注明細"、"商品マスター"の各テーブルを使って、受注した商品の詳細を一覧で表示します。

&#9312; [作成]タブ - [クエリ] - [クエリデザイン]をクリックします。

![](./pic/createquery1.png)

![](./pic/createquery2.png)

&#9313; テーブルタブから以下のテーブルを選択 - [追加]をクリック - [閉じる]をクリックします。

-   顧客マスター
-   受注
-   受注明細
-   商品マスター

![](./pic/createquery3.png)

![](./pic/createquery4.png)

&#9314; "クエリ1"ウィンドウを最大化し、見やすくします。

&#9315; 結合線を確認します。

![](./pic/createquery5.png)

&#9316; "受注明細"の"受注ＩＤ"をダブルクリックします。

![](./pic/createquery6.png)

&#9317; 同様に以下のテーブルから以下のフィールドを追加してください。

-   "受注"テーブル："受注日"フィールド
-   "受注"テーブル："顧客ＩＤ"フィールド
-   "顧客マスター"テーブル："顧客名"フィールド
-   "受注明細"テーブル："商品コード"フィールド
-   "商品マスター"テーブル："商品名"フィールド
-   "商品マスター"テーブル："定価"フィールド
-   "受注明細"テーブル："数量"フィールド

&#9318; [クエリツール] - [デザイン]タブ - [結果] - ![](./pic/action.png) ([実行])ボタンをクリックします。

![](./pic/createquery7.png)

![](./pic/createquery8.png)

&#9319; "Ｑ受注登録"と入力して、名前を付けて保存します。


### クエリでデータを変更する
---
&#9312; "Ｑ受注登録"の一番上のレコードの"顧客ＩＤ"フィールドの値を"1"に変更 - [Enter]キーを押します。

![](./pic/revisequery1.png)

"顧客名"フィールドが"山本伊平"に変わりました。

![](./pic/revisequery2.png)

&#9313; 一番上のレコードの"商品コード"フィールドの値を"K-200"に変更 - [Enter]キーを押します。

![](./pic/revisequery3.png)

"商品名"フィールドが"コピー用紙"に変わりました。

![](./pic/revisequery4.png)

&#9314; 上書き保存をして、レコードを保存します。


### 演算フィールドを追加する
---
&#9312; "デザインビュー"に切り替えます。

![](./pic/calcquery1.png)

&#9313; "数量"フィールドの右側に"金額:定価*数量"と入力 - [Enter]キーを押し、 [クエリツール] - [デザイン]タブ - [結果] - ![](./pic/action.png) ([実行])を押します。

![](./pic/calcquery2.png)

&#9314; "金額"フィールドが追加されました。

![](./pic/calcquery3.png)

&#9315; 上書き保存をします。


### 課題
---
"paper.accdb"にもリレーションシップを設定します。授業の初めにダウンロードした"paper.accdb"を開き、以下の指示に従って、リレーションシップを作成してください。

1. 以下のテーブルをリレーションシップウィンドウに追加してください。

    -   顧客マスター
    -   受注
    -   受注明細
    -   商品マスター
    -   地域

2. 以下のフィールド間でリレーションシップを設定してください。

    - "顧客マスター"テーブルと"受注"テーブル："顧客ＩＤ"フィールド
    - "受注"テーブルと"受注明細"テーブル："受注ＩＤ"フィールド
    - "受注明細"テーブルと"商品マスター"テーブル："商品コード"フィールド
    - "地域"テーブルと"顧客マスター"テーブル："地域コード"フィールド

3. リレーションシップを保存します。
4. 以下の要素からなるクエリを作成します。

    -   "受注明細"テーブル："受注ＩＤ"フィールド
    -   "受注"テーブル："受注日"フィールド
    -   "受注"テーブル："顧客ＩＤ"フィールド
    -   "顧客マスター"テーブル："顧客名"フィールド
    -   "受注明細"テーブル："商品コード"フィールド
    -   "商品マスター"テーブル："商品名"フィールド
    -   "商品マスター"テーブル："定価"フィールド
    -   "受注明細"テーブル："数量"フィールド

作成したら、リレーションシップが正常に作動しているかどうかを調べるために以下の変更を加えます。
5. 一番上のレコード（受注IDが1、顧客名が伊東祐子、商品コードがB-500）の"顧客ID"フィールドの値を"15"に変更し、"顧客名"フィールドが"畠山慶"になることを確認します。
6. 同じレコードの"商品コード"を"S-400"に変更し、"商品名"が"鉛筆"になり、"定価"が"\1,200"になることを確認します。
7. 最後に、演算フィールドを追加します。
8. デザインビューに切り替え、"数量"フィールドの右側に、表示名を"金額"とし、数量と定価と8%の消費税を掛け合わせたものを追加してください。
9. [実行]を押して、"金額"フィールドが追加され、一番上のレコード（受注IDが３、顧客名が長野業平、商品コードがB-500）のものが"14040"になることを確認します。
10. "受注明細クエリ"として保存し、閉じます。

> ヒント：消費税が8%だと、消費税分は元の金額に0.08を掛けたものです。では、最終的な値段は何倍になりますか？
> 操作が分からなければ第12講で"年会費"をどうやって作ったのか思い出してみましょう。
